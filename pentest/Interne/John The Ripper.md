```toc

```

Cf https://cheatsheet.haax.fr/passcracking-hashfiles/john_cheatsheet/

# Cassage NTDS en bref
D'abord, on vérifie que les hash LM sont tous vides :
```bash
john --format=LM <ntds_file>
```
Si c'est le cas, la commande finit instantanément. Sinon, il suffit d'être patient pour récupérer les premiers mdp (on peut utiliser les techniques suivantes aussi sur les hash LM).

Ensuite on passe aux hash NT :
```bash
# Really basic : test password~=login, then short wirdlist, then pure bruteforce
# It never ends (exhaustive bruteforce), so stop when you want
john --format=NT <ntds_file>
# With rockyou
john --format=NT --wordlist=/usr/share/wordlists/rockyou.txt <ntds_file>
# With rockyou and default rules (need a wordlist)
john --format=NT --wordlist=/usr/share/wordlists/rockyou.txt --rules <ntds_file>

# ---- Do some more advanced stuff now ----
# Create a custom wordlist with years (2019, 2020, ...), name of company, department number, city name, application/service names, ...
# Don't put "Company2021" but put "Company" and "2021" (prince mode will make it)
john --format=NT --wordlist=<custom_wordlist> --rules <ntds_file>
# Use all rules (replace o by 0, a by @, ...)
john --format=NT --wordlist=<custom_wordlist> --rules=all <ntds_file>
# Create another wordlist with all usernames (without domain\)
# Then use all rules
john --format=NT --wordlist=<usernames_wordlist> --rules=all <ntds_file>

# Prince mode : concatenate different passwords from wordlist
john --format=NT --prince=<custom_wordlist> --rules <ntds_file>
# Create a custom local config file with rules (see example below)
john --format=NT --wordlist=<custom_wordlist> --rules=<rule_name> --config=<rules_file> <ntds_file>
# Test all previous commands with public french wordlists too
# Ex : https://github.com/clem9669/wordlists.git 
# In particular, use a wordlist with names and add rules (ex : <name><year>)

# ---- Want some infinite bruteforce ? ----
# Incremental mode with digits only
john --format=NT --incremental=digits <ntds_file>
# Incremental (wait at least 40 min)
john --format=NT --incremental <ntds_file>
# Incremental with more than 8 caracters
john --format=NT --incremental --min-length=8 <ntds_file> 

# Show cracked password
john --format=NT --show <ntds_file>
```


## Exemple de fichier de règles
On peut mettre des règles dans un fichier local "john-local.conf" et l'utiliser avec la commande suivante : `john --format=NT --wordlist=wordlist.txt --rules=myrule --config=john-local.conf <file>`
```bash
[List.Rules:myrule]
# as-is
:
# append a number
: $[0-9]
# append 2 numbers
: $[0-9]$[0-9]
# append 3 numbers
: $[0-9]$[0-9]$[0-9]
# append 4 numbers
: $[0-9]$[0-9]$[0-9]$[0-9]
# append 4 numbers and "nothing exotic"
: $[0-9]$[0-9]$[0-9]$[0-9]$[0-9A-Za-z#!?.-_*]
# prepend a number
: ^[0-9]
# prepend 2 numbers
: ^[0-9]^[0-9]
# prepend 3 numbers
: ^[0-9]^[0-9]^[0-9]
# prepend 4 numbers
: ^[0-9]^[0-9]^[0-9]^[0-9]
# prepend 4 numbers and "nothing exotic"
: ^[0-9]^[0-9]^[0-9]^[0-9]^[0-9A-Za-z#!?.-_*]
# prepend a number and append a number
: ^[0-9]$[0-9]
# toggle capitalize
t
# capitalize
c
# capitalize and append a number
c $[0-9]
# capitalize and append 2 numbers
c $[0-9]$[0-9]
# capitalize and append 3 numbers
c $[0-9]$[0-9]$[0-9]
# capitalize and append 4 numbers
c $[0-9]$[0-9]$[0-9]$[0-9]
# capitalize and append 4 numbers and "nothing exotic"
c $[0-9]$[0-9]$[0-9]$[0-9]$[0-9A-Za-z#!?.-_*]
# capitalize and prepend a number
c ^[0-9]
# capitalize and prepend 2 numbers
c ^[0-9]^[0-9]
# capitalize and prepend 3 numbers
c ^[0-9]^[0-9]^[0-9]
# capitalize and prepend 4 numbers
c ^[0-9]^[0-9]^[0-9]^[0-9]
# capitalize and prepend 4 numbers and "nothing exotic"
c ^[0-9]^[0-9]^[0-9]^[0-9]^[0-9A-Za-z#!?.-_*]
# capitalize and prepend a number and append a number
c ^[0-9]$[0-9]
# append "nothing exotic"
: $[0-9A-Za-z#!?.-_*]
# capitalize and append "nothing exotic"
c $[0-9A-Za-z#!?.-_*]
# prepend "nothing exotic"
: ^[0-9A-Za-z#!?.-_*]
# capitalize and prepend "nothing exotic"
c ^[0-9A-Za-z#!?.-_*]  
```


# Explication
## Basic
```bash
# Crack NT hash
john --format=NT <file>
john --format=NT <file> --show 
john --restore
```

## Wordlist
```bash 
john --format=NT --wordlist=<path_to_list> <file>
```

*Rockyou* est présent ici sur Kali : */usr/share/wordlists/rockyou.txt*
On peut trouver des wordlist françaises ici : https://github.com/clem9669/wordlists.git 

## Rules
### Utilisation des règles par défaut
Les règles par défaut utilise la wordlist pour en dériver de nouveau mots de passe potentiels. C'est extrêmement efficace !
```bash
john --format=NT --wordlist=<path_to_list> --rules <file>
```

On peut alors créer une liste de mot de passe custom adapté au contexte du client et utiliser les règles !

Il y a 5 ensemble de règles utilisables par défaut : 
- Single
- Wordlist
- Extra
- Jumbo = single + wordlist + extra
- KoreLogic
- All
```bash
john --format=NT --wordlist=<path_to_list> --rules=Extra <file>
```

### Règles custom
Pour définir des règles particulières en accord avec la politique de mots de passe, il faut les ajouter soit dans le fichier de configuration de John : */etc/john/john.conf*, soit dans un fichier *john-local.conf* dans le répertoire d'exécution de John.
Bon article sur les règles possibles : https://miloserdov.org/?p=5477

```bash
john --format=NT --wordlist=<path_to_list> --rules=<rule_name> --config=john-local.conf <file>
```

Longueur minimale de 10 octets sans créer de règles :
```bash
john --format=NT --wordlist=<path_to_list> --min-length=10 <file>
```


## Modes
Quand aucune wordlist n'est précisé, John utilise les modes suivants dans cet ordre :
- *single* : utilise le nom d'utilisateur comme mot de passe et teste des modifications dessus 
- *wordlist* : teste tous les mots de sa wordlist par défaut (pas beaucoup)
- *incremental* : bruteforce total en testant toutes les combinaisons possibles et en augmentant la longueur du mot de passe testé progressivement (ne finit jamais)

Si une wordlist est précisée, John fait uniquement le mode wordlist.

### Mode single
Le mode single est puissant, ne pas oublier de l'utiliser ! En plus il est utilisé par défaut si on ne précise pas de wordlist.
-> Pour qu'il fonctionne il faut garder les noms d'utilisateur dans le fichier des hash.
```bash
john --format=NT --single <file>
```

### Mode prince
Un mode supplémentaire est le mode Prince, qui fonctionne plus ou moins comme le mode wordlist mais en combinant plusieurs mots de passe de la wordlist pour tester des mots de passe plus longs.
Explication ici : https://fossies.org/linux/john/doc/PRINCE
Ce mode se combine très bien avec les règles et les wordlist personnalisées.
```bash
john --format=NT --prince=<path_to_wordlist> --rules <file>
```

### Mode incrémental
On peut lui demande de faire le mode incrémental comme suit :
```bash
john --format=NT --incremental <file>
```

On peut aussi lui demander de faire le mode incrémental seulement avec des chiffres (mot de passe de "0" à "99999999999999999999") avec la commande :
```bash
john --format=NT --incremental=digits <file>
```


## Bonus

Lestat : outils pour associer les mots de passe cassés avec les utilisateurs du domaine, leur groupe et leur statut (actif ou non).
Cf https://github.com/astar-security/Lestat

Cet outil peut soit utiliser 2 fichiers (mdp cassé et info sur les utilisateurs), soit dumper directement la base NTDS et les informations sur les utilisateurs avec un compte administrateur du domaine.
